<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Weekly Work Scheduler ‚Äî Fixed & Seeded (Improved)</title>
  <style>
    :root{
      --bg:#f4f4f4; --card:#fff; --text:#222; --muted:#666; --accent:#007BFF;
      --danger:#ff4d4f; --success:#198754;
    }
    body { font-family: Inter, Arial, sans-serif; margin:20px auto; max-width:1200px; padding:0 12px;
      background:var(--bg); color:var(--text); transition:background .2s,color .2s;}
    body.dark{ --bg:#0f0f10; --card:#161616; --text:#e6e6e6; --muted:#999; --accent:#4ea6ff; }
    h1,h2{ margin:0 0 8px 0; }
    section{ background:var(--card); padding:14px; margin-bottom:16px; border-radius:10px;
      box-shadow:0 2px 10px rgba(0,0,0,0.06); }
    .input-group{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    input[type="text"], input[type="number"], select{ padding:6px 8px; border-radius:6px; border:1px solid #ddd; min-width:140px; }
    button{ padding:6px 10px; border-radius:6px; border:none; background:var(--accent); color:#fff; cursor:pointer; }
    button.secondary{ background:#6c757d; }
    button.danger{ background:var(--danger); }
    button[disabled]{ opacity:.6; cursor:not-allowed; }
    table{ width:100%; border-collapse:collapse; margin-top:10px; }
    th,td{ border:1px solid #e6e6e6; padding:8px; text-align:center; min-width:60px; }
    th{ background:#f6f8fb; }
    .remove-btn{ background:transparent; border:1px solid transparent; color:var(--danger); padding:4px 8px; border-radius:6px; }
    .remove-btn:hover{ background:var(--danger); color:#fff; }
    .person-list-item{ display:flex; align-items:center; gap:8px; padding:6px 8px; border-radius:6px; border:1px solid #eee; margin-bottom:6px; justify-content:space-between; }
    .kitchen-task{ background:#d1e7dd; }
    .work-task{ background:#f8d7da; }
    .avail-cell{ min-width:80px; padding:6px; cursor:pointer; }
    .fairness-box{ margin-top:12px; padding:8px; border-radius:8px; background:#eef6ff; }
    @media (max-width:768px){ .table-scroll{ overflow-x:auto; } }
    /* modal */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.32); display:flex; align-items:flex-start; justify-content:center; z-index:9998; padding:20px; }
    .modal{ background:var(--card); color:var(--text); border-radius:8px; padding:12px; max-width:420px; width:100%; box-shadow:0 10px 40px rgba(0,0,0,0.25); }
    .sr-only{ position:absolute !important; left:-10000px; top:auto; width:1px; height:1px; overflow:hidden; }
  </style>
</head>
<body>
  <h1>Weekly Work Scheduler</h1>

  <section id="people-section" aria-labelledby="people-h">
    <h2 id="people-h">People</h2>
    <div class="input-group" role="group" aria-label="Add person">
      <label for="person-name" class="sr-only">Person name</label>
      <input id="person-name" type="text" placeholder="Enter name" autocomplete="off" />
      <label for="person-gender" class="sr-only">Gender</label>
      <select id="person-gender" aria-label="Gender">
        <option value="Male">Male</option>
        <option value="Female">Female</option>
      </select>
      <button id="add-person-btn" type="button">Add Person</button>
      <button id="export-json-btn" type="button" class="secondary">Export JSON</button>
      <input id="import-json" type="file" accept=".json" style="display:none" />
      <button id="import-json-btn" type="button" class="secondary">Import JSON</button>
    </div>
    <div id="people-list" aria-live="polite" style="margin-top:8px;"></div>
  </section>

  <section id="kitchen-section">
    <h2>Kitchen Tasks</h2>
    <div class="input-group">
      <input type="text" id="kitchen-task-name" placeholder="Enter task (e.g. Breakfast)"/>
      <input type="number" id="kitchen-task-count" placeholder="People needed" min="1" value="1"/>
      <button id="add-kitchen-task-btn" type="button">Add Task</button>
    </div>
    <table id="kitchen-task-table" aria-label="Kitchen tasks table">
      <caption>List of kitchen tasks</caption>
      <thead>
        <tr><th>Task</th><th>People Needed</th><th>Days Needed</th><th>Remove</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="work-section">
    <h2>Work Duties</h2>
    <div class="input-group">
      <input id="work-task-name" type="text" placeholder="Enter task (e.g. Guard)"/>
      <input id="work-task-count" type="number" placeholder="People needed" min="1" value="1"/>
      <select id="work-task-gender" aria-label="Gender required">
        <option>Any</option><option>Male</option><option>Female</option>
      </select>
      <button id="add-work-task-btn" type="button">Add Task</button>
    </div>
    <table id="work-task-table" aria-label="Work tasks table">
      <caption>List of work tasks</caption>
      <thead><tr><th>Task</th><th>People Needed</th><th>Days Needed</th><th>Remove</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="availability-section">
    <h2>Availability</h2>
    <div class="table-scroll">
      <table id="availability-table" aria-label="Availability grid">
        <caption>Availability per person and day ‚Äî click a cell to edit (emoji = slot enabled)</caption>
        <thead>
          <tr><th>Person</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <p style="font-size:13px;color:var(--muted); margin-top:8px;">Click a cell to edit availability for that person/day (emoji = slot enabled).</p>
  </section>

  <div class="input-group" style="margin-bottom:12px;">
    <button id="generate-btn" type="button">Generate Schedule</button>
    <button id="clear-btn" type="button" class="secondary">Clear Schedule</button>
    <button id="download-btn" type="button" class="secondary">Download CSV</button>
    <button id="darkmode-btn" type="button" class="secondary">Toggle Dark Mode</button>
  </div>

  <section id="schedule-section">
    <h2 id="kitchen-schedule-h">Generated Kitchen Schedule</h2>
    <div style="overflow:auto;"><table id="kitchen-schedule-table" class="schedule-table" aria-labelledby="kitchen-schedule-h"></table></div>

    <h2 id="work-schedule-h">Generated Work Duties Schedule</h2>
    <div style="overflow:auto;"><table id="work-schedule-table" class="schedule-table" aria-labelledby="work-schedule-h"></table></div>

    <div id="fairness-summary" class="fairness-box" style="display:none;">
      <h3 style="margin:4px 0;">Fairness summary (assignments per person)</h3>
      <div id="fairness-content" aria-live="polite" role="status"></div>
    </div>
  </section>

  <section style="background:#fff8e1;border:2px solid #ffeb3b;">
    <h3 style="color:#ff6f00; margin:0 0 6px 0;">‚ö†Ô∏è Reset All Data</h3>
    <p style="margin:0 0 8px 0;">This will permanently clear all saved people, tasks and availability.</p>
    <button id="reset-all-btn" type="button" class="danger">Reset All Data</button>
  </section>

  <div id="modal-container" aria-hidden="true"></div>

  <script>
    /* ===== Data + Defaults ===== */
    const STORAGE_KEYS = { people: 'ws_people', kitchen: 'ws_kitchen', work: 'ws_work', availability: 'ws_avail', dark: 'ws_dark' };
    let peopleList = JSON.parse(localStorage.getItem(STORAGE_KEYS.people) || '[]');
    let kitchenTasks = JSON.parse(localStorage.getItem(STORAGE_KEYS.kitchen) || '[]');
    let workTasks = JSON.parse(localStorage.getItem(STORAGE_KEYS.work) || '[]');
    let availability = JSON.parse(localStorage.getItem(STORAGE_KEYS.availability) || '{}');

    const days = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
    const kitchenSubTasks = ["Breakfast","Lunch","Lunch Dishes","Dinner","Dinner Dishes"];
    const allSlots = [...kitchenSubTasks, "Work Duty"];
    const slotEmoji = { "Breakfast":"üç≥","Lunch":"ü•ó","Lunch Dishes":"üçΩÔ∏è","Dinner":"üçù","Dinner Dishes":"üßΩ","Work Duty":"‚öôÔ∏è" };

    /* ===== DOM references ===== */
    const personInput = document.getElementById('person-name');
    const personGender = document.getElementById('person-gender');
    const addPersonBtn = document.getElementById('add-person-btn');
    const peopleContainer = document.getElementById('people-list');

    const kitchenTaskInput = document.getElementById('kitchen-task-name');
    const kitchenTaskCount = document.getElementById('kitchen-task-count');
    const addKitchenTaskBtn = document.getElementById('add-kitchen-task-btn');
    const kitchenTaskTable = document.getElementById('kitchen-task-table').querySelector('tbody');

    const workTaskInput = document.getElementById('work-task-name');
    const workTaskCount = document.getElementById('work-task-count');
    const workTaskGender = document.getElementById('work-task-gender');
    const addWorkTaskBtn = document.getElementById('add-work-task-btn');
    const workTaskTable = document.getElementById('work-task-table').querySelector('tbody');

    const availabilityTable = document.getElementById('availability-table');
    const availabilityTbody = availabilityTable.querySelector('tbody');

    const generateBtn = document.getElementById('generate-btn');
    const clearBtn = document.getElementById('clear-btn');
    const downloadBtn = document.getElementById('download-btn');
    const darkmodeBtn = document.getElementById('darkmode-btn');

    const kitchenScheduleTable = document.getElementById('kitchen-schedule-table');
    const workScheduleTable = document.getElementById('work-schedule-table');

    const fairnessSummaryBox = document.getElementById('fairness-summary');
    const fairnessContent = document.getElementById('fairness-content');

    const exportJsonBtn = document.getElementById('export-json-btn');
    const importFileInput = document.getElementById('import-json');
    const importJsonBtn = document.getElementById('import-json-btn');

    const resetAllBtn = document.getElementById('reset-all-btn');
    const modalContainer = document.getElementById('modal-container');

    /* ===== Utility functions ===== */
    function escapeHtml(str){ return String(str).replace(/[&<>\"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function saveData(){ localStorage.setItem(STORAGE_KEYS.people, JSON.stringify(peopleList)); localStorage.setItem(STORAGE_KEYS.kitchen, JSON.stringify(kitchenTasks)); localStorage.setItem(STORAGE_KEYS.work, JSON.stringify(workTasks)); localStorage.setItem(STORAGE_KEYS.availability, JSON.stringify(availability)); }
    function setDarkMode(enabled){ document.body.classList.toggle('dark', !!enabled); localStorage.setItem(STORAGE_KEYS.dark, enabled ? '1' : '0'); }
    setDarkMode(localStorage.getItem(STORAGE_KEYS.dark) === '1');
    function shuffle(arr){ const a = arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

    /* ===== Ensure availability data structure ===== */
    function ensureAvailabilityStructure(){
      peopleList.forEach(p=>{
        if(!availability[p.name]) availability[p.name]={};
        days.forEach(d=>{
          if(!availability[p.name][d]) availability[p.name][d]={};
          allSlots.forEach(s=>{ if(availability[p.name][d][s]===undefined) availability[p.name][d][s]=true; });
        });
      });
      Object.keys(availability).forEach(name=>{ if(!peopleList.find(p=>p.name===name)) delete availability[name]; });
    }

    /* ===== Seed default kitchen tasks ===== */
    function seedDefaultKitchenTasks(){
      if(kitchenTasks && kitchenTasks.length>0) return;
      const defaults = kitchenSubTasks.map(name=>({name,count:1,days:Object.fromEntries(days.map(d=>[d,true]))}));
      kitchenTasks = defaults; saveData();
    }

    /* ===== Initial renderers for people/tasks/availability ===== */
    function renderPeople(){ /*...same as before...*/ }
    function renderTasks(taskArray, tbody){ /*...same as before...*/ }
    function renderAvailability(){ /*...same as before...*/ }

    /* ===== Generate schedule ===== */
    function generateSchedule(){ /*...all logic same, with CSV fixes below...*/ }

    /* ===== CSV download (fixed newlines) ===== */
    downloadBtn.addEventListener('click', ()=>{
      function tableToCSV(table){
        if(!table || !table.rows || table.rows.length===0) return '';
        const lines=[];
        for(let r=0;r<table.rows.length;r++){
          const cells = table.rows[r].cells;
          const row=[];
          for(let c=0;c<cells.length;c++){ row.push('"'+(cells[c].textContent||'').replace(/"/g,'""')+'"'); }
          lines.push(row.join(','));
        }
        return lines.join('\n');
      }
      const kitchenCSV = tableToCSV(kitchenScheduleTable);
      const workCSV = tableToCSV(workScheduleTable);
      const fairnessText = Array.from(document.querySelectorAll('#fairness-content div')).map(d=>d.textContent).join('\n');
      const combined = ['"Kitchen Schedule"','',kitchenCSV,'','"Work Schedule"','',workCSV,'','"Fairness Summary"','','"'+fairnessText.replace(/"/g,'""')+'"'].join('\n');
      const blob=new Blob([combined],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='schedule.csv'; a.click(); URL.revokeObjectURL(url);
    });

    /* ===== JSON import/export, dark mode, reset, initial render ===== */
    /*...same as your previous code...*/

  </script>
</body>
</html>
