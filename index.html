<!-- weekly-scheduler-fixed.html -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weekly Scheduler (Fixed)</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: var(--bg);
    color: var(--text);
    margin: 0;
    padding: 0;
  }
  :root {
    --bg: #fff;
    --text: #000;
    --accent: #3498db;
    --danger: #e74c3c;
  }
  body.dark {
    --bg: #1e1e1e;
    --text: #f0f0f0;
  }
  h1,h2,h3 { margin-top: 0; }
  section { margin: 1em; border: 1px solid #ccc; padding: 1em; border-radius: 8px; }
  table { border-collapse: collapse; width: 100%; margin-top: .5em; }
  th, td { border: 1px solid #ccc; padding: .4em; text-align: center; }
  button { cursor: pointer; margin: 2px; }
  button.remove-btn { color: var(--danger); border: 1px solid var(--danger); background: transparent; }
  button.remove-btn:hover { background: var(--danger); color: #fff; }
  label { margin-right: .5em; }
  .people-list, .tasks-list { display: flex; flex-wrap: wrap; gap: 4px; }
  .person-item, .task-item { border: 1px solid #ccc; padding: 4px 8px; border-radius: 6px; display: flex; align-items: center; justify-content: space-between; }
  .person-item button, .task-item button { margin-left: 6px; }
  #availability-table td { cursor: pointer; }
  #availability-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg); color: var(--text); border: 2px solid var(--accent); border-radius: 8px; padding: 1em; z-index: 1000; display: none; }
  #availability-modal.active { display: block; }
  #availability-modal input { margin-right: 6px; }
  .dark-toggle { position: fixed; top: 10px; right: 10px; }
  .sr-only { position:absolute; left:-9999px; }
</style>
</head>
<body>
<button id="dark-toggle" class="dark-toggle">Toggle Dark Mode</button>
<h1>Weekly Work Scheduler</h1>

<section id="people-section">
  <h2>People</h2>
  <div>
    <input id="person-name" placeholder="Name"> <select id="person-gender"><option value="Any">Any</option><option value="Male">Male</option><option value="Female">Female</option></select>
    <button id="add-person">Add Person</button>
    <button id="export-json">Export JSON</button>
    <input id="import-json" type="file" accept=".json" hidden />
    <button id="import-json-btn" type="button">Import JSON</button>
  </div>
  <div class="people-list" id="people-list" aria-live="polite"></div>
</section>

<section id="kitchen-section">
  <h2>Kitchen Tasks</h2>
  <div>
    <input id="kitchen-task" placeholder="Task"> <input id="kitchen-count" type="number" value="1" min="1">
    <button id="add-kitchen-task">Add</button>
  </div>
  <table aria-label="Kitchen tasks table"><caption class="sr-only">Kitchen tasks and assigned people</caption>
    <thead><tr><th>Task</th><th>Count</th><th>Days Needed</th><th>Action</th></tr></thead>
    <tbody id="kitchen-table"></tbody>
  </table>
</section>

<section id="work-section">
  <h2>Work Duties</h2>
  <div>
    <input id="work-task" placeholder="Task"> <input id="work-count" type="number" value="1" min="1">
    <select id="work-gender"><option value="Any">Any</option><option value="Male">Male</option><option value="Female">Female</option></select>
    <button id="add-work-task">Add</button>
  </div>
  <table aria-label="Work duties table"><caption class="sr-only">Work duties and assigned people</caption>
    <thead><tr><th>Task</th><th>Count</th><th>Gender</th><th>Days Needed</th><th>Action</th></tr></thead>
    <tbody id="work-table"></tbody>
  </table>
</section>

<section id="availability-section">
  <h2>Availability</h2>
  <table id="availability-table"><caption class="sr-only">Availability per person per day</caption></table>
</section>

<section id="schedule-section">
  <h2>Generated Schedule</h2>
  <button id="generate-schedule">Generate Schedule</button>
  <button id="clear-schedule">Clear Schedule</button>
  <button id="download-csv">Download CSV</button>
  <button id="reset-all">Reset All</button>
  <div id="schedules"></div>
</section>

<div id="availability-modal" role="dialog" aria-modal="true">
  <h3>Edit Availability</h3>
  <div id="availability-checkboxes"></div>
  <button id="save-availability">Save</button>
  <button id="cancel-availability">Cancel</button>
</div>

<script>
const STORAGE_KEYS={people:'ws_people',kitchen:'ws_kitchen',work:'ws_work',avail:'ws_avail',dark:'ws_dark'};
let peopleList=[],kitchenTasks=[],workTasks=[],availability={};
const days=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
const slots=['Breakfast','Lunch','Lunch Dishes','Dinner','Dinner Dishes','Work Duty'];
const $=sel=>document.querySelector(sel);

function saveAll(){localStorage.setItem(STORAGE_KEYS.people,JSON.stringify(peopleList));localStorage.setItem(STORAGE_KEYS.kitchen,JSON.stringify(kitchenTasks));localStorage.setItem(STORAGE_KEYS.work,JSON.stringify(workTasks));localStorage.setItem(STORAGE_KEYS.avail,JSON.stringify(availability));}
function loadAll(){peopleList=JSON.parse(localStorage.getItem(STORAGE_KEYS.people)||'[]');kitchenTasks=JSON.parse(localStorage.getItem(STORAGE_KEYS.kitchen)||'[]');workTasks=JSON.parse(localStorage.getItem(STORAGE_KEYS.work)||'[]');availability=JSON.parse(localStorage.getItem(STORAGE_KEYS.avail)||'{}');if(localStorage.getItem(STORAGE_KEYS.dark)==='1')document.body.classList.add('dark');}

function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}

function renderPeople(){const list=$('#people-list');list.innerHTML='';peopleList.forEach((p,i)=>{const el=document.createElement('div');el.className='person-item';el.innerHTML=`${p.name} (${p.gender}) <button class="remove-btn" data-i="${i}">×</button>`;list.appendChild(el);});}
function renderKitchen(){const table=$('#kitchen-table');table.innerHTML='';kitchenTasks.forEach((t,i)=>{const row=document.createElement('tr');const daysHTML=days.map(d=>`<label><input type="checkbox" data-day="${d}" ${t.days[d]?'checked':''}>${d}</label>`).join(' ');row.innerHTML=`<td>${t.name}</td><td>${t.count}</td><td>${daysHTML}</td><td><button class="remove-btn" data-i="${i}">×</button></td>`;table.appendChild(row);});}
function renderWork(){const table=$('#work-table');table.innerHTML='';workTasks.forEach((t,i)=>{const daysHTML=days.map(d=>`<label><input type="checkbox" data-day="${d}" ${t.days[d]?'checked':''}>${d}</label>`).join(' ');const row=document.createElement('tr');row.innerHTML=`<td>${t.name}</td><td>${t.count}</td><td>${t.genderRequired}</td><td>${daysHTML}</td><td><button class="remove-btn" data-i="${i}">×</button></td>`;table.appendChild(row);});}

function renderAvailability(){const table=$('#availability-table');table.innerHTML='<thead><tr><th>Name</th>'+days.map(d=>`<th>${d}</th>`).join('')+'</tr></thead>';
const tbody=document.createElement('tbody');peopleList.forEach(p=>{const row=document.createElement('tr');row.innerHTML=`<td>${p.name}</td>`+days.map(d=>{const icons=(availability[p.name]?.[d])?Object.keys(availability[p.name][d]).filter(s=>availability[p.name][d][s]).map(s=>s[0]).join(''):'-';return `<td tabindex="0" data-person="${p.name}" data-day="${d}">${icons}</td>`;}).join('');tbody.appendChild(row);});table.appendChild(tbody);}

function openModal(person,day){const modal=$('#availability-modal');modal.classList.add('active');modal.dataset.person=person;modal.dataset.day=day;const wrap=$('#availability-checkboxes');wrap.innerHTML='';slots.forEach(s=>{const checked=availability[person]?.[day]?.[s]?'checked':'';wrap.innerHTML+=`<label><input type="checkbox" data-slot="${s}" ${checked}>${s}</label><br>`;});}
$('#cancel-availability').onclick=()=>$('#availability-modal').classList.remove('active');
$('#save-availability').onclick=()=>{const modal=$('#availability-modal');const p=modal.dataset.person,d=modal.dataset.day;availability[p]=availability[p]||{};availability[p][d]={};document.querySelectorAll('#availability-checkboxes input').forEach(cb=>availability[p][d][cb.dataset.slot]=cb.checked);
// mutual linkage between Work Duty and Lunch Dishes
const linkA=availability[p][d]['Work Duty'];
const linkB=availability[p][d]['Lunch Dishes'];
if(linkA!==linkB){availability[p][d]['Work Duty']=availability[p][d]['Lunch Dishes']=linkA||linkB?true:false;}

$('#availability-modal').classList.remove('active');saveAll();renderAvailability();}

$('#availability-table').onclick=e=>{if(e.target.dataset.person)openModal(e.target.dataset.person,e.target.dataset.day);}

$('#add-person').onclick=()=>{const name=$('#person-name').value.trim();if(!name)return;const gender=$('#person-gender').value;peopleList.push({name,gender});availability[name]={};saveAll();renderPeople();renderAvailability();}
$('#people-list').onclick=e=>{if(e.target.classList.contains('remove-btn')){const i=e.target.dataset.i;peopleList.splice(i,1);saveAll();renderPeople();renderAvailability();}}

$('#add-kitchen-task').onclick=()=>{const name=$('#kitchen-task').value.trim();if(!name)return;const count=+$('#kitchen-count').value||1;const daysObj={};days.forEach(d=>daysObj[d]=true);kitchenTasks.push({name,count,days:daysObj});saveAll();renderKitchen();}
$('#kitchen-table').onclick=e=>{if(e.target.classList.contains('remove-btn')){const i=e.target.dataset.i;kitchenTasks.splice(i,1);saveAll();renderKitchen();}}

$('#add-work-task').onclick=()=>{const name=$('#work-task').value.trim();if(!name)return;const count=+$('#work-count').value||1;const gender=$('#work-gender').value;const daysObj={};days.forEach(d=>daysObj[d]=true);workTasks.push({name,count,genderRequired:gender,days:daysObj});saveAll();renderWork();}
$('#work-table').onclick=e=>{if(e.target.classList.contains('remove-btn')){const i=e.target.dataset.i;workTasks.splice(i,1);saveAll();renderWork();}}

$('#import-json-btn').onclick=()=>$('#import-json').click();
$('#import-json').onchange=e=>{const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=()=>{const data=JSON.parse(reader.result);peopleList=data.peopleList||[];kitchenTasks=data.kitchenTasks||[];workTasks=data.workTasks||[];availability=data.availability||{};saveAll();renderPeople();renderKitchen();renderWork();renderAvailability();};reader.readAsText(file);}
$('#export-json').onclick=()=>{const data={peopleList,kitchenTasks,workTasks,availability,ts:new Date().toISOString()};const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='scheduler.json';a.click();}

$('#dark-toggle').onclick=()=>{document.body.classList.toggle('dark');localStorage.setItem(STORAGE_KEYS.dark,document.body.classList.contains('dark')?'1':'0');}

$('#reset-all').onclick=()=>{if(confirm('Reset all data?')){Object.values(STORAGE_KEYS).forEach(k=>localStorage.removeItem(k));location.reload();}}

$('#download-csv').onclick=()=>{let csv='### Kitchen Schedule\n';csv+='Task,'+days.join(',')+'\n';kitchenTasks.forEach(t=>{csv+=`${t.name},`+days.map(d=>t.days[d]?'✓':'').join(',')+'\n';});csv+='\n### Work Duties\n';workTasks.forEach(t=>{csv+=`${t.name},`+days.map(d=>t.days[d]?'✓':'').join(',')+'\n';});const blob=new Blob([csv],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='schedule.csv';a.click();}

loadAll();renderPeople();renderKitchen();renderWork();renderAvailability();
</script>
</body>
</html>
